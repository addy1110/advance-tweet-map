<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Scalable TweetMap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Loading Bootstrap -->
    <link href="./bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="./bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Loading Flat UI -->
    <link href="./css/flat-ui.css" rel="stylesheet">
    <link href="./css/map.css" rel="stylesheet">
    <link href="./css/flatui-colorDrop.css" rel="stylesheet">

    <link rel="shortcut icon" href="images/favicon.ico">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
    <!--<script src="js/html5shiv.js"></script>-->
    <![endif]-->
</head>
<body>

<div id="status">
</div>
<aside id="sidebar" class="wet-asphalt">
    <header>
        <h3 class="turquoise-text">Scalable TweetMap</h3>

    </header>


    <ul class="sidebar-options">
        <li>
            <h4><b><i>Trending  HashTags</i></b></h4>

            <select id="dropdown" onChange = "myFunction(value)">
                <option  >---select---</option>
                <option value="trump" >Donald Trump</option>
                <option value="gym" >Gym</option>
                <option value="music" >Music</option>
                <option value="food" >Food</option>
                <option value="ipl" >IPL</option>
                <option value="usa" >USA</option>
                <option value="life" >Life</option>
                <option value="body" >Body</option>
            </select>

        </li>
        <!--<h2><b> Total Hits: <span id ="count" style = "color: red">  0 </h2> </span></b></h2></br>-->
        <!--<p> Please Login to see live tweets.</p>-->
        <!--<div class="fb-login-button" data-max-rows="1" data-size="xlarge" data-show-faces="false" data-auto-logout-link="true"></div>-->

    </ul>

</aside>
<div id="map">

</div>
<!-- /#map -->
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.3.6.min.js"></script>
<script type="text/javascript">
    // See the Configuring section to configure credentials in the SDK
    // Configure your region
    AWS.config.region = 'us-east-1';
    var creds = new AWS.Credentials({
        accessKeyId: "AKIAJTH7KJBQSHTCILBA", secretAccessKey: "6GtrEqcBm8J9mlhmeK8hGKE8iUa+N91UNEzUqu84"
    });

</script>

<!-- Load JS here for greater good =============================-->
<script src="js/jquery-1.8.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/flatui-colorDrop.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyD_YvA_eULjy4iBAey7gLffIdHBwcFCkiA"></script>
<script>
    var map = new google.maps.Map( document.getElementById( 'map' ), {
        zoom: 5,
        center: new google.maps.LatLng(40.7128, -74.0059),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        minZoom: 1
    });

    (function( $, google ) {


        var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
        var beachMarker = new google.maps.Marker({
            position: {lat: 40.7128, lng: -74.0059},
            map: map,
            icon: image
        });
        $('.btn-group').colorDrop({
            onChange: function() {
                changeMapStyles( map );
            }
        });

        $('#map').height($(window).height());

        function changeMapStyles( map ) {

            var hueColor = '#e67e22',
                roadColor = '#d35400',
                waterColor = '#2980b9',
                parkColor = '#16a085',
                landscapeColor = '#bdc3c7';

            var featureOpts = [
                {
                    stylers: [
                        { hue: hueColor }
                    ]
                },{
                    elementType: "labels",
                    stylers: [{
                        visibility: "on"
                    }]
                },{
                    featureType: "road",
                    stylers: [{
                        visibility: "on"
                    }, {
                        color: roadColor
                    }]
                },{
                    featureType: "water",
                    stylers: [{
                        visibility: "on"
                    }, {
                        color: waterColor
                    }]
                },
                {
                    featureType: "poi"
                    ,stylers: [{
                    visibility: "on"
                }, {
                    color: parkColor
                }]
                },
                {
                    featureType: "landscape",
                    stylers: [{
                        visibility: "on"
                    }, {
                        color: landscapeColor
                    }]
                }
            ];

            map.setOptions({
                styles: featureOpts
            });

        }

        changeMapStyles( map );

    })( jQuery, google );
    var markers = [];
    var hashTag = '';
    var refreshIntervalId='';
    function myFunction(value) {
        setMapOnAll(null);
//        document.getElementById("count").innerHTML = "Loading...";
        hashTag = value;
        $.ajax({
            dataType: "text",
            url: 'http://localhost:3000/'+value,
            success: function (data) {
                data = JSON.parse(data);
                //alert(data[0]._source.location.coordinates);
                console.log(data.length);
                var infowindow = new google.maps.InfoWindow();
                var contentString = '';
//                document.getElementById("count").innerHTML = data.length;

                for( i =0; i < data.length; i++) {
                    try{
                        //console.log(data[i]._source.location.coordinates);
                        var latLng = new google.maps.LatLng(data[i]._source.location.coordinates[0],data[i]._source.location.coordinates[1]);

                        contentString = "<b>Username:</b>"+data[i]._source.username+"<br><b>Tweet: </b>"+data[i]._source.text+"<br><b>Sentiment Score: </b>"+(data[i]._source.sentiment.score*100).toFixed(2)+"% <i>"+data[i]._source.sentiment.type+"</i>";

                        // Creating a marker and putting it on the map
                        var marker = new google.maps.Marker({
                            position: latLng,
                            map: map,
                            clickable: true,
                            content: contentString,
                            title: "Location: "+JSON.stringify(data[i]._source.location.coordinates)
                        });
                        google.maps.event.addListener(marker, 'click', (function (marker, i) {
                            return function () {
                                infowindow.setContent(marker.content);
                                infowindow.open(map, marker);
                            }
                        })(marker, i));

                        //marker.setAnimation(google.maps.Animation.DROP);
                        markers.push(marker);

                        if(data[i]._source.sentiment.type == "positive") {
                            marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
                        }
                        else if(data[i]._source.sentiment.type == "neutral") {
                            marker.setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png')
                        }
                        else if(data[i]._source.sentiment.type == "negative") {
                            marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png')
                        }
                    }
                    catch(e) {
                        console.log("Syntax Error: "+e);
                    }
                }


            }
        });
        showTweets();

    }

    function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }



    var showTweets = function() { //trying to fetch tweets from sqs.
        var recParams = {
            QueueUrl: 'https://sqs.us-east-1.amazonaws.com/829344914533/tweet-map-processor', /* required */
            MaxNumberOfMessages: 1,
            AttributeNames: [
                "All"
            ],
            /* more items */
            VisibilityTimeout: 60,
            WaitTimeSeconds: 20
        };

            var sqs = new AWS.SQS({apiVersion: '2012-11-05', credentials : creds});

            sqs.receiveMessage(recParams, function(err, data) {
                if (err) console.log(err, err.stack); // an error occurred
                else    {
                    try{
                        //console.log("Received "+JSON.stringify(data));

                        fetchedText = JSON.parse(data.Messages[0].Body);
                        fetchedText = JSON.parse(JSON.parse(fetchedText.Message).http);
                        var tweet = String(fetchedText.text);
                        console.log("Fetched: "+fetchedText.text);
                        console.log(tweet.indexOf(hashTag) > -1);
                        var latLng = new google.maps.LatLng(fetchedText.location.coordinates[0],fetchedText.location.coordinates[1]);

                        // Creating a marker and putting it on the map
                        if(tweet.indexOf(hashTag) > -1 )
                        {
                            contentString = "<b>Username:</b> "+fetchedText.username+"<br><b>Tweet: </b>"+fetchedText.text+"<br><b>Sentiment Score: </b>"+(fetchedText.sentiment.score*100).toFixed(2)+"% <i>"+fetchedText.sentiment.type+"</i>";
                            var infowindow = new google.maps.InfoWindow({
                                content: contentString
                            });
                            var marker = new google.maps.Marker({
                                position: latLng,
                                map: map,
                                clickable: true,
                                content: contentString,
                                title: "Location: "+fetchedText.location.coordinates
                            });
                            google.maps.event.addListener(marker, 'click', (function (marker) {
                                return function () {
                                    infowindow.setContent(marker.content);
                                    infowindow.open(map, marker);
                                }
                            })(marker));
                            if(fetchedText.sentiment.type == "positive") {
                                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
                            }
                            else if(fetchedText.sentiment.type == "neutral") {
                                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png')
                            }
                            else if(fetchedText.sentiment.type == "negative") {
                                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png')
                            }
                            markers.push(marker);
                            marker.setAnimation(google.maps.Animation.DROP);
                            marker.setMap(map);
                            var count = document.getElementById("count").innerHTML;

                            var count = +count + +1;
                            document.getElementById("count").innerHTML =count;
                        }

                    }

                    catch(e){
                        console.log(e);
                    }
                }
            });

    };
</script>
</body>
</html>
